<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Multi Cloner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #00d2ff; --secondary: #ff00de;
            --glass-bg: rgba(20, 20, 30, 0.6); --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff; --input-bg: rgba(0, 0, 0, 0.3);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0c29; background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            color: var(--text-color); margin: 0; min-height: 100vh; overflow-x: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container {
            width: 90%; max-width: 600px;
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 30px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            animation: fadeIn 1s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h1 { text-align: center; margin-bottom: 20px; font-weight: 600; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #aaa; }
        textarea, input[type="text"] {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border);
            background: var(--input-bg); color: #fff; font-family: 'Poppins', sans-serif; resize: vertical; outline: none; transition: 0.3s;
            box-sizing: border-box; /* Fix padding issue */
        }
        textarea:focus, input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); }
        
        .btn-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;}
        button {
            flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.3s;
            background: linear-gradient(45deg, var(--primary), var(--secondary)); color: #fff; min-width: 120px;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4); }
        button.btn-secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); }
        button.btn-danger { background: linear-gradient(45deg, #ff416c, #ff4b2b); }
        button.btn-info { background: linear-gradient(45deg, #2193b0, #6dd5ed); }
        
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar-bg { width: 100%; height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s ease; }
        .status-text { margin-top: 5px; font-size: 0.85rem; text-align: center; color: #ddd; }
        
        .log-area {
            height: 150px; overflow-y: auto; background: rgba(0, 0, 0, 0.5); border-radius: 10px; padding: 10px;
            font-family: 'Consolas', monospace; font-size: 0.8rem; border: 1px solid var(--glass-border);
        }
        .log-item { margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-success { color: #00ff88; } .log-error { color: #ff4d4d; } .log-info { color: #00d2ff; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        .timer { text-align: center; font-size: 1.2rem; margin-bottom: 10px; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body>
    <div id="tsparticles"></div>
    
    <div class="container">
        <h1>G-Drive Cloner Pro</h1>
        
        <div class="input-group">
            <label>Masukkan URL Folder/File (Satu per baris)</label>
            <textarea id="folderUrls" rows="4" placeholder="https://drive.google.com/drive/folders/...\nhttps://drive.google.com/file/d/..."></textarea>
        </div>

        <div class="timer" id="timer">00:00:00</div>

        <div class="btn-container">
            <button id="btnStart" onclick="startCloning()">üöÄ Mulai Cloning</button>
            <button id="btnStop" class="btn-danger" onclick="stopCloning()" disabled>‚õî Stop</button>
            <button id="btnBg" class="btn-secondary" onclick="toggleBackground()" disabled>‚òÅÔ∏è Background Mode</button>
            <button id="btnQuota" class="btn-info" onclick="checkQuota()">üìä Cek Kuota</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-text">
                <span id="progressPercent">0%</span> - <span id="progressText">Menunggu...</span>
            </div>
        </div>

        <div class="input-group">
            <label>Log Aktivitas <span style="float:right; cursor:pointer; color:var(--secondary)" onclick="clearLog()">[Hapus Log]</span></label>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>

    <script>
        // GANTI URL INI DENGAN URL DEPLOYMENT WEB APP ANDA
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzMhTT8zwLTV26UtM0T2nd8tsp9U8xjoFNGHp1h-xJ30ZZwjVORtEBiqXe8laV7MhDcg/exec"; 

        const folderUrlsInput = document.getElementById('folderUrls');
        const startBtn = document.getElementById('btnStart');
        const stopBtn = document.getElementById('btnStop');
        const bgToggle = document.getElementById('btnBg');
        const quotaBtn = document.getElementById('btnQuota');
        const progressBar = document.getElementById('progressBar');
        const logArea = document.getElementById('logArea');
        const timerDisplay = document.getElementById('timer');
        
        let isRunning = false;
        let timerInterval;

        // --- QUOTA FUNCTION (BARU) ---
        async function checkQuota() {
            quotaBtn.disabled = true;
            quotaBtn.innerHTML = "‚è≥ Loading...";
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_quota' })
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    Swal.fire({
                        title: 'Info Kuota',
                        html: `
                            <div style="text-align:left; font-size:0.9rem">
                                <p><strong>Akun:</strong> ${result.data.user}</p>
                                <p><strong>Drive Terpakai:</strong> ${result.data.storageUsed}</p>
                                <p><strong>Sisa Limit Harian:</strong> ${result.data.dailyQuota}</p>
                                <hr>
                                <small style="color:#aaa">*Limit harian mengacu pada kuota email/trigger tersisa, bukan jumlah file yang bisa dicopy.</small>
                            </div>
                        `,
                        icon: 'info',
                        background: '#24243e',
                        color: '#fff'
                    });
                } else {
                    addLog('Gagal cek kuota: ' + result.message, 'error');
                }
            } catch (error) {
                addLog('Error koneksi cek kuota', 'error');
                console.error(error);
            } finally {
                quotaBtn.disabled = false;
                quotaBtn.innerHTML = "üìä Cek Kuota";
            }
        }

        // --- MAIN FUNCTIONS ---
        async function startCloning() {
            const urls = folderUrlsInput.value.trim().split('\n').filter(u => u.trim() !== '');
            if (urls.length === 0) {
                Swal.fire({ icon: 'warning', title: 'Oops...', text: 'Masukkan setidaknya satu URL!', background: '#24243e', color: '#fff' });
                return;
            }

            setRunningState(true);
            addLog('Memulai proses cloning...', 'info');
            startTimer();

            try {
                // Menggunakan mode background job (lebih stabil untuk banyak file)
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'start_background_multi', urls: urls })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    addLog('Job terdaftar ID: ' + result.jobId, 'success');
                    monitorJob();
                } else {
                    addLog('Gagal memulai: ' + result.message, 'error');
                    setRunningState(false);
                }
            } catch (error) {
                addLog('Error koneksi: ' + error.message, 'error');
                setRunningState(false);
            }
        }

        async function monitorJob() {
            if (!isRunning) return;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'check_background_status' })
                });
                const result = await response.json();
                
                if (result.status === 'success' && result.job) {
                    const job = result.job;
                    
                    // Update Logs
                    if (job.logs && job.logs.length > 0) {
                        // Hanya tampilkan log terakhir agar tidak spam
                        const lastLog = job.logs[job.logs.length - 1];
                        updateProgress(Math.floor((job.currentIndex / job.urls.length) * 100), lastLog);
                        
                        // Tampilkan semua log baru (logic sederhana)
                        // Idealnya kita track index log terakhir di client side
                        // Disini kita clear dan re-render simple atau append yg beda
                        // Agar simple, kita append log status saja
                    }

                    if (job.status === 'completed') {
                        finishCloning();
                    } else {
                        setTimeout(monitorJob, 5000); // Poll setiap 5 detik
                    }
                } else {
                    if (result.status === 'idle') {
                        addLog('Tidak ada job aktif.', 'info');
                        setRunningState(false);
                    } else {
                        setTimeout(monitorJob, 5000);
                    }
                }
            } catch (e) {
                console.log("Polling error", e);
                setTimeout(monitorJob, 10000); // Retry lebih lama
            }
        }

        async function stopCloning() {
            if (!confirm('Yakin ingin menghentikan proses?')) return;
            
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'stop_background' })
                });
                addLog('Mengirim perintah stop...', 'info');
                setRunningState(false);
                stopTimer();
            } catch (e) {
                addLog('Gagal stop: ' + e.message, 'error');
            }
        }

        function finishCloning() {
            setRunningState(false);
            stopTimer();
            updateProgress(100, "Selesai!");
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            Swal.fire({ icon: 'success', title: 'Selesai!', text: 'Semua proses cloning telah selesai.', background: '#24243e', color: '#fff' });
        }

        function setRunningState(active) {
            isRunning = active;
            startBtn.disabled = active;
            stopBtn.disabled = !active;
            folderUrlsInput.disabled = active;
            bgToggle.disabled = active;
            document.getElementById('progressContainer').style.display = active ? 'block' : 'none';
        }

        function toggleBackground() {
            // Placeholder func
            alert("Mode background otomatis aktif saat Start ditekan.");
        }

        function updateProgress(percent, text) {
            progressBar.style.width = percent + "%";
            document.getElementById('progressPercent').textContent = percent + "%";
            document.getElementById('progressText').textContent = shortUrl(text);
        }

        function addLog(msg, type) {
            const div = document.createElement('div'); div.className = 'log-item log-' + type; div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logArea.appendChild(div); logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() { logArea.innerHTML = ''; }
        function shortUrl(url) { return url.length > 40 ? url.substring(0, 35) + "..." : url; }

        // --- TIMER FUNCTIONS ---
        function startTimer() {
            const startTime = Date.now();
            timerDisplay.textContent = "00:00:00";
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const hours = Math.floor(elapsedTime / 3600000);
                const minutes = Math.floor((elapsedTime % 3600000) / 60000);
                const seconds = Math.floor((elapsedTime % 60000) / 1000);
                timerDisplay.textContent = 
                    `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        function pad(n) { return n < 10 ? "0" + n : n; }

        // --- PARTICLES ---
        tsParticles.load("tsparticles", {
            fpsLimit: 60,
            particles: {
                color: { value: "#ffffff" },
                links: { color: "#ffffff", distance: 150, enable: true, opacity: 0.1, width: 1 },
                move: { enable: true, speed: 1, direction: "none", random: false, straight: false, outModes: { default: "bounce" } },
                number: { density: { enable: true, area: 800 }, value: 40 },
                opacity: { value: 0.2 },
                shape: { type: "circle" },
                size: { value: { min: 1, max: 3 } },
            },
            detectRetina: true,
        });
    </script>
</body>
</html>
