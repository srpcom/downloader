// ==========================================
// KONFIGURASI GLOBAL
// ==========================================
// ID Folder Tujuan Anda (Sudah diisi sesuai permintaan)
var DEST_FOLDER_ID = "1MRs9gSs3O7h85HkMqO6wv6TJsxw6jyBO"; 
var LOG_SHEET_ID = "1R5Lb6NIkFDDx2otW1AgjWniGZf2X7UjUKQ19ee6vqUc"; 
var SCRIPT_PROP = PropertiesService.getScriptProperties();

// ==========================================
// API HANDLER (DO POST)
// ==========================================
function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var action = data.action;

    if (action === 'initialize') {
      return handleInitialize(data.url, data.name);
    } else if (action === 'process_batch') {
      return handleBatch(data.jobId);
    } else if (action === 'start_background_multi') {
      return startBackgroundJob(data.urls);
    } else if (action === 'stop_background') {
      return stopBackgroundJob();
    } else if (action === 'check_background_status') {
      return checkBackgroundStatus();
    } else {
      return responseJSON({ status: 'error', message: "Action tidak dikenal" });
    }

  } catch (error) {
    return responseJSON({ status: 'error', message: "Error: " + error.toString() });
  }
}

// ==========================================
// [1] BACKGROUND JOB SYSTEM
// ==========================================
function startBackgroundJob(urls) {
  var status = SCRIPT_PROP.getProperty('BG_JOB_STATUS');
  if (status === 'RUNNING') {
    return responseJSON({ status: 'error', message: "Sedang ada proses background berjalan. Stop dulu atau tunggu selesai." });
  }

  var masterJob = {
    urls: urls,
    currentIndex: 0,
    currentJobId: null,
    totalProcessed: 0,
    startTime: new Date().getTime(),
    status: 'RUNNING'
  };
  saveMasterJob(masterJob);
  SCRIPT_PROP.setProperty('BG_JOB_STATUS', 'RUNNING');

  deleteTriggers();
  ScriptApp.newTrigger('backgroundTriggerHandler').timeBased().everyMinutes(1).create();

  return responseJSON({ status: 'success', message: "Background Process Dimulai. Anda boleh menutup tab ini." });
}

function stopBackgroundJob() {
  deleteTriggers();
  SCRIPT_PROP.setProperty('BG_JOB_STATUS', 'STOPPED');
  return responseJSON({ status: 'success', message: "Background Process Dihentikan." });
}

function checkBackgroundStatus() {
  var status = SCRIPT_PROP.getProperty('BG_JOB_STATUS') || 'IDLE';
  var masterJob = loadMasterJob();
  var details = masterJob ? "Link " + (masterJob.currentIndex + 1) + " dari " + masterJob.urls.length : "";
  return responseJSON({ status: 'success', bgStatus: status, details: details });
}

function backgroundTriggerHandler() {
  var masterJob = loadMasterJob();
  if (!masterJob || SCRIPT_PROP.getProperty('BG_JOB_STATUS') !== 'RUNNING') {
    deleteTriggers(); return;
  }

  var startTime = new Date().getTime();
  var MAX_EXECUTION_TIME = 280 * 1000;

  try {
    while (masterJob.currentIndex < masterJob.urls.length) {
      if (new Date().getTime() - startTime > MAX_EXECUTION_TIME) return;

      var currentUrl = masterJob.urls[masterJob.currentIndex];

      if (!masterJob.currentJobId) {
        var initResult = handleInitialize(currentUrl, "");
        var initData = JSON.parse(initResult.getContent());
        
        if (initData.status === 'success') {
          masterJob.currentJobId = initData.jobId;
          saveMasterJob(masterJob);
        } else {
          logToSheet(getLogSheet(), "SYSTEM", "Skip Link", "Error: " + initData.message, currentUrl, "-", "-");
          masterJob.currentIndex++;
          masterJob.currentJobId = null;
          saveMasterJob(masterJob);
          continue; 
        }
      }

      var isFolderDone = false;
      while (!isFolderDone) {
         if (new Date().getTime() - startTime > MAX_EXECUTION_TIME) return;

         var batchResult = handleBatch(masterJob.currentJobId);
         var batchData = JSON.parse(batchResult.getContent());

         if (batchData.status === 'success') {
           if (batchData.action === 'complete') isFolderDone = true;
         } else {
           isFolderDone = true;
         }
      }

      if (isFolderDone) {
        masterJob.currentIndex++;
        masterJob.currentJobId = null;
        saveMasterJob(masterJob);
      }
    }
    stopBackgroundJob();
    logToSheet(getLogSheet(), "SYSTEM", "Background Job", "COMPLETED", "All Items", "-", "-");
  } catch (e) { console.error("BG Error: " + e.message); }
}

// ==========================================
// [2] FOREGROUND HANDLERS (INITIALIZE & BATCH)
// ==========================================
function handleInitialize(sourceUrl, customName) {
  var lock = LockService.getScriptLock();
  lock.waitLock(10000); 
  try {
    var sourceId = extractIdFromUrl(sourceUrl);
    if (!sourceId) return responseJSON({ status: 'error', message: "URL Invalid" });

    // 1. Deteksi apakah FILE atau FOLDER
    var isFolder = false;
    var sourceItem = null;
    var sourceName = "";
    
    try {
      var fileTest = DriveApp.getFileById(sourceId);
      // Cek MimeType untuk membedakan shortcut folder vs file asli
      if (fileTest.getMimeType() === MimeType.FOLDER) {
        isFolder = true;
        sourceItem = DriveApp.getFolderById(sourceId);
      } else {
        isFolder = false;
        sourceItem = fileTest;
      }
      sourceName = sourceItem.getName();
    } catch (e) {
      try {
        sourceItem = DriveApp.getFolderById(sourceId);
        sourceName = sourceItem.getName();
        isFolder = true;
      } catch (e2) {
        return responseJSON({ status: 'error', message: "Akses Ditolak / Link Salah / File Tidak Ditemukan" });
      }
    }

    // 2. Tentukan Folder Tujuan (Menggunakan ID yang sudah diset di atas)
    var targetParent;
    try {
      if (DEST_FOLDER_ID && DEST_FOLDER_ID.length > 5) {
        targetParent = DriveApp.getFolderById(DEST_FOLDER_ID);
      } else {
        throw new Error("ID Kosong");
      }
    } catch(err) {
      // Fallback: Jika ID salah/tidak bisa diakses, buat folder baru
      var it = DriveApp.getFoldersByName("Auto Backup Drive");
      if (it.hasNext()) targetParent = it.next();
      else targetParent = DriveApp.createFolder("Auto Backup Drive");
    }

    var finalTargetFolder;
    var targetUrlForFrontend;

    if (isFolder) {
      // JIKA FOLDER: Buat Folder Baru sebagai Wadah di dalam DEST_FOLDER_ID
      var destName = customName || "Copy of " + sourceName;
      finalTargetFolder = targetParent.createFolder(destName);
      
      // Set Permission
      try { finalTargetFolder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch (e) {}
      
      targetUrlForFrontend = finalTargetFolder.getUrl();
    } else {
      // JIKA FILE: LANGSUNG KE DEST_FOLDER_ID (Tanpa membuat folder wadah)
      finalTargetFolder = targetParent;
      targetUrlForFrontend = targetParent.getUrl();
    }

    var jobData = {
      jobId: Utilities.getUuid(),
      status: 'running',
      totalFiles: 0,
      processedFiles: 0,
      totalSize: 0,
      processedSize: 0,
      queue: [],
      rootTargetUrl: targetUrlForFrontend,
      logSheetId: LOG_SHEET_ID
    };

    if (isFolder) {
      scanFolderRecursive(sourceItem, finalTargetFolder.getId(), jobData);
    } else {
      // Logic Single File
      var newFileName = customName || sourceItem.getName();
      jobData.queue.push({ 
        type: 'file', 
        id: sourceItem.getId(), 
        name: newFileName, 
        size: sourceItem.getSize(), 
        targetFolderId: finalTargetFolder.getId(), 
        url: sourceItem.getUrl() 
      });
      jobData.totalFiles = 1; jobData.totalSize = sourceItem.getSize();
    }
    saveJobState(jobData);

    return responseJSON({ 
      status: 'success', 
      action: 'initialized', 
      jobId: jobData.jobId, 
      totalFiles: jobData.totalFiles, 
      totalSize: formatBytes(jobData.totalSize), 
      sourceName: sourceName,
      targetUrl: targetUrlForFrontend
    });

  } finally { lock.releaseLock(); }
}

function scanFolderRecursive(folder, targetFolderId, jobData) {
  var files = folder.getFiles();
  while (files.hasNext()) {
    var file = files.next();
    jobData.queue.push({ type: 'file', id: file.getId(), name: file.getName(), size: file.getSize(), targetFolderId: targetFolderId, url: file.getUrl() });
    jobData.totalFiles++; jobData.totalSize += file.getSize();
  }
  var subFolders = folder.getFolders();
  while (subFolders.hasNext()) {
    var sub = subFolders.next();
    var targetSub = DriveApp.getFolderById(targetFolderId).createFolder(sub.getName());
    scanFolderRecursive(sub, targetSub.getId(), jobData);
  }
}

function handleBatch(jobId) {
  var BATCH_SIZE = 10; 
  var batchItems = [];
  var currentJobState = null;
  var lock = LockService.getScriptLock();
  lock.waitLock(10000); 

  try {
    var jobData = loadJobState(jobId);
    if (!jobData) return responseJSON({ status: 'error', message: "Job ID tidak ditemukan" });

    if (jobData.queue.length === 0) {
      deleteJobState(jobId); 
      return responseJSON({ 
        status: 'success', 
        action: 'complete', 
        progress: { processed: jobData.totalFiles, total: jobData.totalFiles, percent: 100 },
        details: { folderUrl: jobData.rootTargetUrl } 
      });
    }

    var count = 0;
    while (count < BATCH_SIZE && jobData.queue.length > 0) {
      batchItems.push(jobData.queue.shift());
      jobData.processedFiles++; jobData.processedSize += batchItems[batchItems.length-1].size;
      count++;
    }
    saveJobState(jobData);
    currentJobState = jobData; 
  } finally { lock.releaseLock(); }

  var logSheet = getLogSheet(); 
  var logBuffer = []; 
  var time = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm:ss");

  for (var i = 0; i < batchItems.length; i++) {
    var item = batchItems[i];
    try {
      if (item.type === 'file') {
        var file = DriveApp.getFileById(item.id);
        var targetFolder = DriveApp.getFolderById(item.targetFolderId);
        var newFile = file.makeCopy(item.name, targetFolder);
        logBuffer.push([time, "File", item.name, "Success", item.url, newFile.getUrl(), formatBytes(item.size)]);
      }
    } catch (e) {
      logBuffer.push([time, "File", item.name, "Error: " + e.message, item.url, "-", "-"]);
    }
  }

  if (logBuffer.length > 0) {
    try {
      var lastRow = logSheet.getLastRow();
      logSheet.getRange(lastRow + 1, 1, logBuffer.length, logBuffer[0].length).setValues(logBuffer);
    } catch(e) {}
  }

  return responseJSON({
    status: 'success', action: 'continue', jobId: jobId,
    progress: { processed: currentJobState.processedFiles, total: currentJobState.totalFiles, percent: Math.round((currentJobState.processedFiles / currentJobState.totalFiles) * 100), currentSize: formatBytes(currentJobState.processedSize), totalSize: formatBytes(currentJobState.totalSize) }
  });
}

// ==========================================
// UTILS & STORAGE
// ==========================================
function saveMasterJob(data) {
  var fileName = "bg_master_job.json";
  var files = DriveApp.getFilesByName(fileName);
  if (files.hasNext()) files.next().setContent(JSON.stringify(data));
  else DriveApp.createFile(fileName, JSON.stringify(data), MimeType.PLAIN_TEXT);
}
function loadMasterJob() {
  var fileName = "bg_master_job.json";
  var files = DriveApp.getFilesByName(fileName);
  if (files.hasNext()) return JSON.parse(files.next().getBlob().getDataAsString());
  return null;
}
function deleteTriggers() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) { ScriptApp.deleteTrigger(triggers[i]); }
}
function extractIdFromUrl(url) {
  var match = url.match(/(?:\/folders\/|\/d\/|id=)([-\w]{25,})/);
  if (match && match[1]) return match[1];
  var simpleMatch = url.match(/[-\w]{25,}/);
  return simpleMatch ? simpleMatch[0] : null;
}
function saveJobState(data) {
  var fileName = "temp_job_" + data.jobId + ".json";
  var files = DriveApp.getFilesByName(fileName);
  if (files.hasNext()) files.next().setContent(JSON.stringify(data));
  else DriveApp.createFile(fileName, JSON.stringify(data), MimeType.PLAIN_TEXT);
}
function loadJobState(jobId) {
  var fileName = "temp_job_" + jobId + ".json";
  var files = DriveApp.getFilesByName(fileName);
  if (files.hasNext()) return JSON.parse(files.next().getBlob().getDataAsString());
  return null;
}
function deleteJobState(jobId) {
  var fileName = "temp_job_" + jobId + ".json";
  var files = DriveApp.getFilesByName(fileName);
  if (files.hasNext()) files.next().setTrashed(true);
}
function getLogSheet() {
  var ss; try { ss = SpreadsheetApp.openById(LOG_SHEET_ID); } catch(e) { ss = SpreadsheetApp.create("Log Copy"); }
  return ss.getSheets()[0];
}
function logToSheet(sheet, type, name, status, oldUrl, newUrl, size) {
  var time = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm:ss");
  try { sheet.appendRow([time, type, name, status, oldUrl, newUrl, size]); } catch(e) {}
}
function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes';
  var k = 1024; var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  var i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
